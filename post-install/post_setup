#!/bin/bash

# Setting useful variables
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
installed=true
hypervisor=$(systemd-detect-virt)

# Log on desktop (default user when post-install runs after first boot)
LOG_DIR="/home/default/Desktop"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/post-install.log"
ERROR_FILE="/tmp/post-install-error"
rm -f "$ERROR_FILE"

exec > >(tee -a "$LOG_FILE")
exec 2>&1

# Stop on first error and show it instead of freezing
error_exit() {
  local msg="$1"
  echo "POST_INSTALL_ERROR: $msg" >> "$LOG_FILE"
  echo "$msg" > "$ERROR_FILE"
  echo "ERROR: $msg" >&2
  exit 1
}

echo "=== pearOS Post-Install Script Started: $(date) ==="
set -x

if [ "$#" -ne 7 ]; then
  echo "KEYMAP=$1"
  echo "LOCALE=$2"
  echo "ZONE=$3"
  echo "user_passwd=$4"
  echo "FULL_NAME=$5"
  echo "USER_NAME=$6"
  echo "HOST_NAME=$7"
  echo " ^ The above list represents your selected configurations."
  echo "Invalid number of arguments (expected 7)." > "$ERROR_FILE"
  exit 2
fi

# Various settings for the installation process
KEYMAP="$1" # us
LOCALE="$2" # en_US.UTF-8
utc_enabled=false # true | false
ZONE="$3" # Europe/Bucharest
user_passwd="$4" # user password: pear
FULL_NAME="$5" # Full Name
USER_NAME="$6" # username (to log into your system)
HOST_NAME="$7" # hostname for the system

# Check the username
if printf "%s" "$USER_NAME" | grep -Eoq "^[a-z][a-z0-9-]*$" \
  && [ "${#USER_NAME}" -lt 33 ]; then
  if grep -Fxq "$USER_NAME" "$DIR"/reserved_usernames; then
    echo "Reserved username: $USER_NAME. Abort." > "$ERROR_FILE"
    exit 2
  fi
  else
    echo "Invalid Username: $USER_NAME. Abort." > "$ERROR_FILE"
    exit 2
  fi

# Remove the script from the autostart
echo "Removing autostart entry..."
rm -rf /etc/skel/.config/autostart/xyz.pearos-post-install.desktop

# Set/load the keymap
echo "Setting keymap to $KEYMAP..."
if ! localectl set-keymap "$KEYMAP"; then
  error_exit "Failed to set keymap: $KEYMAP"
fi
if ! loadkeys "$KEYMAP"; then
  error_exit "Failed to load keymap: $KEYMAP"
fi

# Pushing Timezone to localtime file
echo "Setting timezone to $ZONE..."
if ! ln -sf /usr/share/zoneinfo/"$ZONE" /etc/localtime; then
  error_exit "Failed to set timezone: $ZONE"
fi

# Enable or disable UTC time
echo "Configuring hardware clock..."
if $utc_enabled; then
  if ! hwclock --systohc --utc; then
    error_exit "Failed to set hardware clock to UTC"
  fi
else
  if ! hwclock --systohc --localtime; then
    error_exit "Failed to set hardware clock to localtime"
  fi
fi

# Passing custom locale to locale file
echo "Configuring locale: $LOCALE..."
if [ "$LOCALE" != "en_US.UTF-8" ]; then
  if ! sed -i "s/#$LOCALE/$LOCALE/" /etc/locale.gen; then
    error_exit "Failed to configure locale in /etc/locale.gen"
  fi
fi

# making the language equal to the locale, and passing to locale.conf
if ! echo "LANG=$LOCALE" | tee /etc/locale.conf; then
  error_exit "Failed to write /etc/locale.conf"
fi

# If there is a custom keymap, add it to the vconsole
if [ "$KEYMAP" != "us" ]; then
  echo "Configuring custom keymap..."
  if ! echo "KEYMAP=$KEYMAP" | tee /etc/vconsole.conf; then
    error_exit "Failed to write /etc/vconsole.conf"
  fi
fi

# Configure X11 keyboard layout (for X11 desktop environments)
# Note: localectl set-keymap (called above) works for both X11 and Wayland
# This X11-specific config ensures compatibility with X11-only applications
if [ -d /usr/share/X11 ]; then
  echo "Configuring X11 keyboard layout..."
  if ! mkdir -p /etc/X11/xorg.conf.d; then
    echo "ERROR: Failed to create /etc/X11/xorg.conf.d directory" >&2
    exit 1
  fi
    if ! echo -e "Section \"InputClass\"\nIdentifier \"system-keyboard\"\nMatchIsKeyboard \"on\"\nOption \"XkbLayout\" \"$KEYMAP\"\nEndSection" > /etc/X11/xorg.conf.d/00-keyboard.conf; then
      error_exit "Failed to configure X11 keyboard"
    fi
  fi

# Note: For Wayland, localectl set-keymap (called above) is sufficient
# Most Wayland compositors (including Plasma Wayland) read keyboard layout from systemd/localectl
# Individual compositors may have additional config files, but localectl covers the base configuration

# Committing the locale settings
echo "Generating locale..."
if ! locale-gen; then
  error_exit "Failed to generate locale"
fi

# Setting the hostname
echo "Setting hostname to $HOST_NAME..."
if ! echo "$HOST_NAME" | tee /etc/hostname; then
  error_exit "Failed to set hostname"
fi

# Add the grub theme to the configuration file
echo "Generating grub configuration..."
if ! grub-mkconfig -o /boot/grub/grub.cfg; then
  error_exit "Failed to generate grub configuration"
fi

# Add user to wheel and sudoers
echo "Creating user $USER_NAME..."
if ! useradd -m -g users -G wheel -s /bin/bash "$USER_NAME"; then
  error_exit "Failed to create user: $USER_NAME"
fi

echo "User $USER_NAME created successfully with sudo access"

if ! chpasswd <<<"$USER_NAME:$user_passwd"; then
  error_exit "Failed to set password for $USER_NAME"
fi

# Backup sudoers before modifying
echo "Configuring sudo access..."
if [ -f /etc/sudoers ]; then
  cp /etc/sudoers /etc/sudoers.backup.$(date +%Y%m%d_%H%M%S)
fi

if ! sed -i 's/# %wheel ALL=(ALL) ALL$/%wheel ALL=(ALL) ALL/' /etc/sudoers; then
  error_exit "Failed to configure sudoers"
fi

echo "Adding user to wheel group..."
if ! echo "$USER_NAME   ALL=(ALL) ALL" | tee /etc/sudoers; then
  error_exit "Failed to add user to wheel group in sudoers"
fi

# Profile picture: ~/.face.icon for new user and SDDM themes (critical for login screen)
echo "Setting profile picture (avatar)..."
PROFILE_PIC_FILE="/tmp/profile_picture"
if [ -f "$PROFILE_PIC_FILE" ] && [ -s "$PROFILE_PIC_FILE" ]; then
  PROFILE_PIC_SRC="$(cat "$PROFILE_PIC_FILE" | tr -d '\n\r')"
  if [ -n "$PROFILE_PIC_SRC" ] && [ -f "$PROFILE_PIC_SRC" ] && [ -r "$PROFILE_PIC_SRC" ]; then
    # 1. New user's home avatar
    USER_HOME="/home/$USER_NAME"
    USER_FACE="$USER_HOME/.face.icon"
    if [ -d "$USER_HOME" ]; then
      if ! cp -f "$PROFILE_PIC_SRC" "$USER_FACE"; then
        error_exit "Failed to copy profile picture to $USER_FACE"
      fi
      chown "$USER_NAME:users" "$USER_FACE" 2>/dev/null || true
      echo "Profile picture set for user $USER_NAME"
    fi

    # 2. Extras (global profile picture)
    EXTRAS_FACE="/usr/share/extras/.face.icon"
    if ! mkdir -p /usr/share/extras; then
      error_exit "Failed to create /usr/share/extras"
    fi
    if ! cp -f "$PROFILE_PIC_SRC" "$EXTRAS_FACE"; then
      error_exit "Failed to copy profile picture to $EXTRAS_FACE"
    fi
    if [ ! -f "$EXTRAS_FACE" ] || [ ! -s "$EXTRAS_FACE" ]; then
      error_exit "Profile picture missing or empty after copy: $EXTRAS_FACE"
    fi
    echo "Profile picture set in /usr/share/extras"

    # 3. SDDM themes â€“ mandatory; do not skip
    # pearOS theme uses images/.face.icon as fallback (Main.qml); some use faces/.face.icon
    SDDM_THEMES="pearOS pearOS-dark"
    for theme in $SDDM_THEMES; do
      THEME_ROOT="/usr/share/sddm/themes/$theme"
      for subdir in faces images; do
        SDDM_DIR="$THEME_ROOT/$subdir"
        SDDM_FACE="$SDDM_DIR/.face.icon"
        if ! mkdir -p "$SDDM_DIR"; then
          error_exit "Failed to create SDDM directory: $SDDM_DIR"
        fi
        if ! cp -f "$PROFILE_PIC_SRC" "$SDDM_FACE"; then
          error_exit "Failed to copy profile picture to SDDM theme $theme ($subdir): $SDDM_FACE"
        fi
        if [ ! -f "$SDDM_FACE" ] || [ ! -s "$SDDM_FACE" ]; then
          error_exit "SDDM profile picture missing or empty after copy: $SDDM_FACE"
        fi
      done
      echo "Profile picture set for SDDM theme: $theme (faces + images)"
    done
  else
    echo "Profile picture source missing or not readable: $PROFILE_PIC_SRC" >&2
  fi
else
  echo "No profile picture selected (/tmp/profile_picture missing or empty), skipping avatar setup"
fi

# Fix extras files permissions (fixes the theme-switcher bug)
echo "Fixing permissions for extras..."
if ! chmod -R 0777 /usr/share/extras; then
  echo "WARNING: Failed to set permissions on /usr/share/extras" >&2
fi

# Remove useless packages and their desktop entries
echo "Removing unnecessary packages..."
if ! yes | LC_ALL=en_US.UTF-8 pacman -R electron npm plasma-sdk discover; then
  echo "WARNING: Some packages failed to remove" >&2
fi

echo "Removing desktop entries..."
rm -rf /usr/share/applications/avahi-discover.desktop \
       /usr/share/applications/bssh.desktop \
       /usr/share/applications/bvnc.desktop \
       /usr/share/applications/qv4l2.desktop \
       /usr/share/applications/qvidcap.desktop \
       /usr/share/applications/org.kde.plasma.emojier \
       /usr/share/applications/calamares*

# Remove sddm.conf > it is set to autologin user 'default', which breaks the system
echo "Removing old SDDM configuration..."
if [ -f /etc/sddm.conf ]; then
  cp /etc/sddm.conf /etc/sddm.conf.backup.$(date +%Y%m%d_%H%M%S)
  rm -f /etc/sddm.conf
fi

# Installing yay helper
#git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si --noconfirm

# Installing plymouth
#yay -S plymouth --noconfirm

# Setting pearOS plymouth theme
#plymouth-set-default-theme -R pear-plymouth

# Remove 'default' user. It can be very dangerous
echo "Removing default user..."
if id "default" &>/dev/null; then
  if ! userdel -rf default; then
    error_exit "Failed to remove default user"
  fi
  echo "Default user removed successfully"
else
  echo "Default user does not exist, skipping..."
fi

# Fixing the SDDM theme
echo "Configuring SDDM theme..."
cat > /etc/sddm.conf << 'EOF'
[Autologin]
Session=plasma

[Theme]
Current=pearOS
EOF

if [ $? -ne 0 ]; then
  error_exit "Failed to write SDDM configuration"
fi

echo "=== pearOS Installation Script Completed: $(date) ==="
echo "System will reboot in 10 seconds. Press Ctrl+C to cancel..."
sleep 10

# Final reboot
sync && systemctl reboot -i
